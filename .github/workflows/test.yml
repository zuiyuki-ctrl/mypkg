name: Test system_monitor package

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - ros-distro: humble
            ubuntu: ubuntu-22.04
          - ros-distro: iron
            ubuntu: ubuntu-22.04
          - ros-distro: jazzy
            ubuntu: ubuntu-24.04

    runs-on: ${{ matrix.ubuntu }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Set up ROS 2 GPG key and repository
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg2 lsb-release
        # Remove old/expired ROS 2 sources and keys
        sudo rm -f /etc/apt/sources.list.d/ros2-latest.list
        sudo rm -f /etc/apt/trusted.gpg.d/ros.gpg
        sudo rm -f /usr/share/keyrings/ros-archive-keyring.gpg
        # Install new GPG key using modern method
        sudo mkdir -p /usr/share/keyrings
        curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo gpg --dearmor -o /usr/share/keyrings/ros-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/ros2-latest.list > /dev/null
        sudo apt-get update

    - name: Install ROS 2 ${{ matrix.ros-distro }}
      run: |
        sudo apt-get install -y ros-${{ matrix.ros-distro }}-desktop
        sudo apt-get install -y python3-colcon-common-extensions

    - name: Install dependencies
      run: |
        sudo apt-get install -y python3-psutil

    - name: Build package
      shell: bash
      run: |
        source /opt/ros/${{ matrix.ros-distro }}/setup.bash
        cd ${{ github.workspace }}
        colcon build --packages-select system_monitor

    - name: Test package
      shell: bash
      run: |
        source /opt/ros/${{ matrix.ros-distro }}/setup.bash
        source ${{ github.workspace }}/install/setup.bash
        colcon test --packages-select system_monitor

    - name: Check test results
      shell: bash
      run: |
        source /opt/ros/${{ matrix.ros-distro }}/setup.bash
        colcon test-result --verbose
        if [ $? -ne 0 ]; then
          echo "Some tests failed. Showing detailed results:"
          colcon test-result --all
          exit 1
        fi

